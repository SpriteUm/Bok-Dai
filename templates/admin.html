<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard | BOK DAI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .urgency-dot { font-size: 1.25rem; line-height: 1; vertical-align: middle; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    </style>
</head>
<body class="bg-[#E6E8E5] text-[#2F4F2F] min-h-screen">
    <div class="min-h-screen flex">
        <aside class="w-60 bg-[#5C7F5C] text-white flex flex-col">
            <div class="px-4 py-4 border-b border-[#8FAF8F]">
                <h1 class="text-lg font-bold">BOK DAI</h1>
                <p class="text-xs text-[#C2D3C2]">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</p>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2 text-sm">
                <a href="{{ url_for('admin.dashboard') }}" class="block px-2 py-1 rounded bg-[#C2D3C2] text-[#2F4F2F] font-medium">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                <a href="{{ url_for('admin.manage_issues') }}" class="block px-2 py-1 rounded hover:bg-[#8FAF8F]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
                <a href="{{ url_for('admin.manage_users') }}" class="block px-2 py-1 rounded hover:bg-[#8FAF8F]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a>
                <a href="{{ url_for('auth.logout') }}" class="block px-2 py-1 rounded hover:bg-[#8FAF8F]">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
            </nav>
        </aside>

        <main class="flex-1 p-6 flex flex-col gap-6">
            <header>
                <h2 class="text-xl font-semibold">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h2>
                <p class="text-xs text-[#8FAF8F]">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
            </header>

            <section>
                <div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                    <div class="bg-white border border-[#8FAF8F] rounded-lg p-4 shadow">
                        <h3 class="text-xs font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <p class="text-xl font-bold text-[#5C7F5C]">{{ total_issues or 0 }}</p>
                    </div>
                    <div class="bg-white border border-[#8FAF8F] rounded-lg p-4 shadow">
                        <h3 class="text-xs font-medium">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                        <p class="text-xl font-bold text-yellow-500">{{ issues_pending or 0 }}</p>
                    </div>
                    <div class="bg-white border border-[#8FAF8F] rounded-lg p-4 shadow">
                        <h3 class="text-xs font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                        <p class="text-xl font-bold text-orange-500">{{ issues_in_progress or 0 }}</p>
                    </div>
                    <div class="bg-white border border-[#8FAF8F] rounded-lg p-4 shadow">
                        <h3 class="text-xs font-medium">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</h3>
                        <p class="text-xl font-bold text-green-600">{{ issues_completed or 0 }}</p>
                    </div>
                    <div class="bg-white border border-[#8FAF8F] rounded-lg p-4 shadow">
                        <h3 class="text-xs font-medium">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <p class="text-xl font-bold text-[#5C7F5C]">{{ issues_today or 0 }}</p>
                    </div>
                    <div class="bg-white border border-[#8FAF8F] rounded-lg p-4 shadow">
                        <h3 class="text-xs font-medium">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å (üî¥)</h3>
                        <p class="text-xl font-bold text-red-600">{{ issues_urgent or 0 }}</p>
                    </div>
                </div>
            </section>

            <section class="flex flex-wrap gap-4">
                <div class="bg-white border border-[#8FAF8F] rounded-lg shadow p-4" style="flex:1 1 60%; min-width:300px;">
                    <div class="relative" style="min-height:250px;">
                        <canvas id="issueChart" data-chart='{{ chart_data|tojson }}'></canvas>
                    </div>
                </div>
                <div class="bg-white border border-[#8FAF8F] rounded-lg shadow p-4" style="flex:1 1 35%; min-width:220px;">
                    <h3 class="text-sm font-medium mb-2">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (30 ‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
                    <div id="hotspotMap" class="rounded-lg border border-gray-200" style="height: 220px;"></div>
                </div>
            </section>

            <section>
                <h3 class="text-sm font-medium mb-2">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
                <div class="bg-white border border-[#8FAF8F] rounded-lg shadow overflow-x-auto">
                    <table class="min-w-full text-xs">
                        <thead class="bg-[#C2D3C2] text-[#2F4F2F]">
                            <tr>
                                <th class="px-3 py-2 text-left">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                <th class="px-3 py-2 text-left">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                <th class="px-3 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                                <th class="px-3 py-2 text-left">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</th>
                                <th class="px-3 py-2 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="px-3 py-2 text-left">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="px-3 py-2 text-left">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="px-3 py-2 text-left">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-[#E6E8E5]">
                            {% for issue in recent_issues %}
                            <tr>
                                <td class="px-3 py-2">{{ issue.category }}</td>
                                <td class="px-3 py-2">{{ issue.detail[:50] }}{% if issue.detail|length > 50 %}...{% endif %}</td>
                                <td class="px-3 py-2">
                                  {% if issue.date_reported %}
                                    {{ issue.date_reported }}
                                  {% elif issue.created_at is string %}
                                    {{ issue.created_at }}
                                  {% elif issue.created_at %}
                                    {% if issue.created_at is string %}
                                      {{ issue.created_at }}
                                    {% else %}
                                      {{ issue.created_at.strftime('%Y-%m-%d') }}
                                    {% endif %}
                                  {% else %}
                                    -
                                  {% endif %}
                                </td>
                                <td class="px-3 py-2 text-left">
                                    {% if issue.urgency == 'üî¥' %}<span class="urgency-dot">üî¥</span><span class="sr-only">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</span>
                                    {% elif issue.urgency == 'üü†' %}<span class="urgency-dot">üü†</span><span class="sr-only">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>
                                    {% elif issue.urgency == 'üü¢' %}<span class="urgency-dot">üü¢</span><span class="sr-only">‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</span>
                                    {% else %}<span class="text-xs text-gray-700">{{ issue.urgency }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-left">
                                    {% if issue.status == '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' %}<span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2.5 py-0.5 rounded-full">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                                    {% elif issue.status == '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß' %}<span class="inline-block bg-green-100 text-green-800 text-xs px-2.5 py-0.5 rounded-full">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</span>
                                    {% else %}<span class="inline-block bg-gray-100 text-gray-700 text-xs px-2.5 py-0.5 rounded-full">{{ issue.status }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2">{{ issue.location_text }}</td>
                                <td class="px-3 py-2">
                                    {% if issue.location_link %}
                                        <button type="button"
                                                class="map-btn inline-block px-3 py-1 text-xs font-medium rounded border border-[#26403a] text-[#1b6b44] bg-[#dff3e8] hover:bg-[#bfe6cf] transition"
                                                data-link="{{ issue.location_link|e }}">
                                            ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                                        </button>
                                    {% else %}
                                        <button class="inline-block px-3 py-1 text-xs font-medium rounded border border-gray-300 text-gray-600 bg-gray-100 cursor-not-allowed" disabled>
                                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå
                                        </button>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2">
                                    <a href="{{ url_for('admin.update_issue_page', issue_id=issue.id) }}" class="inline-block px-3 py-1 bg-[#2f8f5f] text-white rounded text-xs hover:bg-[#26784e] transition">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center text-gray-500 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-xl relative">
        <div class="flex justify-between items-center px-4 py-2 border-b">
          <h3 class="text-sm font-semibold text-[#2F4F2F]">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</h3>
          <button onclick="closeMapModal()" class="text-gray-500 hover:text-gray-700 text-sm">‚úï</button>
        </div>
        <div id="mapContainer" class="w-full h-72"></div>
      </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // Chart rendering (unchanged)
            const canvas = document.getElementById('issueChart');
            if (canvas) {
                const chartDataString = canvas.dataset.chart;
                if (chartDataString) {
                    try {
                        const chartData = JSON.parse(chartDataString);
                        if (chartData.labels && chartData.labels.length > 0) {
                            Chart.register(ChartDataLabels);
                            Chart.defaults.font.family = "'Kanit', sans-serif";
                            Chart.defaults.color = '#2F4F2F';

                            const ctx = canvas.getContext('2d');
                            new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: chartData.labels,
                                    datasets: [{
                                        data: chartData.values,
                                        maxBarThickness: 50,
                                        borderRadius: 6,
                                        backgroundColor: 'rgba(92, 127, 92, 0.6)',
                                        borderColor: 'rgba(92, 127, 92, 1)',
                                        hoverBackgroundColor: 'rgba(92, 127, 92, 0.8)',
                                        barPercentage: 0.7
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å)',
                                            font: { size: 16 },
                                            padding: { bottom: 20 }
                                        },
                                        legend: { display: false },
                                        tooltip: {
                                            backgroundColor: '#2F4F2F',
                                            titleColor: '#E6E8E5',
                                            bodyColor: '#C2D3C2',
                                            padding: 10,
                                            cornerRadius: 4,
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label) { label += ': '; }
                                                    if (context.parsed.y !== null) {
                                                        label += context.parsed.y + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                                                    }
                                                    return label;
                                                }
                                            }
                                        },
                                        datalabels: {
                                            anchor: 'end',
                                            align: 'top',
                                            font: { weight: 'bold', size: 12 },
                                            formatter: (value) => value > 0 ? value : ''
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)' },
                                            grid: { display: false },
                                            grace: '10%'
                                        },
                                        x: { grid: { display: false } }
                                    }
                                }
                            });
                        }
                    } catch (e) { console.error("Failed to parse chart data:", e); }
                }
            }

            // Hotspot map (unchanged apart from using hotspot_data)
            const mapElement = document.getElementById('hotspotMap');
            const hotspotDataString = '{{ hotspot_data|safe }}';

            function generateGMapsLink(lat, lng) {
              return `https://www.google.com/maps/@${lat},${lng},17z`;
            }

            if (mapElement && hotspotDataString) {
                try {
                    const hotspotData = JSON.parse(hotspotDataString);
                    const map = L.map('hotspotMap').setView([13.736717, 100.523186], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19, attribution: '¬© OpenStreetMap'
                    }).addTo(map);

                    if (hotspotData.length > 0) {
                        const markers = [];
                        hotspotData.forEach(point => {
                            let color = '#5C7F5C';
                            if (point.urgency === 'üî¥') color = '#DC2626';
                            if (point.urgency === 'üü†') color = '#F97316';

                            const circle = L.circle([point.lat, point.lng], {
                                color: color, fillColor: color, fillOpacity: 0.6, radius: 40
                            }).addTo(map);

                            const gmapsLink = point.location_link || generateGMapsLink(point.lat, point.lng);

                            const popupContent =
                              `<b>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</b> ${escapeHtml(point.category || '-') }<br>` +
                              `<b>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô:</b> ${escapeHtml(point.urgency || '-') }<br>` +
                              `<a href="${gmapsLink}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps</a>`;

                            circle.bindPopup(popupContent);
                            markers.push(circle);
                        });

                        const featureGroup = L.featureGroup(markers);
                        map.fitBounds(featureGroup.getBounds().pad(0.1));
                    } else {
                        mapElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 p-4 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div>';
                    }
                } catch(e) {
                    console.error("Failed to parse or render hotspot data", e);
                    mapElement.innerHTML = '<div class="flex items-center justify-center h-full text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
                }
            }

            // map button binding: open Google Maps in new tab
            function normalizeLinkForGMaps(raw) {
                if (!raw) return null;
                try {
                    // pattern: contains @lat,lng
                    const atMatch = raw.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (atMatch) return raw;
                    // q=lat,lng
                    const qMatch = raw.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (qMatch) return `https://www.google.com/maps/@${qMatch[1]},${qMatch[2]},17z`;
                    // plain "lat,lng"
                    const latlngMatch = raw.match(/^(-?\d+\.\d+),\s*(-?\d+\.\d+)$/);
                    if (latlngMatch) return `https://www.google.com/maps/@${latlngMatch[1]},${latlngMatch[2]},17z`;
                    // if already a full http(s) link, return it
                    if (/^https?:\/\//i.test(raw)) return raw;
                    return null;
                } catch (e) {
                    return null;
                }
            }

            // bind map buttons that use data-link attribute
            document.querySelectorAll('.map-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const raw = this.getAttribute('data-link') || '';
                    const link = normalizeLinkForGMaps(raw);
                    if (link) {
                        window.open(link, '_blank', 'noopener,noreferrer');
                    } else {
                        console.warn('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ', raw);
                        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ');
                    }
                });
            });

        }); // DOMContentLoaded end

        // Map modal functions (optional usage elsewhere)
        let mapInstance = null;
        function openMapModal(link) {
          const modal = document.getElementById('mapModal');
          const container = document.getElementById('mapContainer');
          modal.classList.remove('hidden');

          const atMatch = link.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
          const qMatch = link.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
          let lat = null, lng = null;
          if (atMatch) { lat = parseFloat(atMatch[1]); lng = parseFloat(atMatch[2]); }
          else if (qMatch) { lat = parseFloat(qMatch[1]); lng = parseFloat(qMatch[2]); }

          container.innerHTML = `
            <div id="map" class="w-full h-full rounded"></div>
            <div class="px-4 py-2 border-t bg-white text-right">
              <a id="openInGMaps" href="#" target="_blank" rel="noopener noreferrer"
                 class="inline-block px-3 py-1 text-xs font-medium rounded border border-[#26403a] text-[#1b6b44] bg-[#dff3e8] hover:bg-[#bfe6cf] transition">
                ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps
              </a>
            </div>
          `;

          if (lat !== null && lng !== null) {
            mapInstance = L.map('map').setView([lat, lng], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' }).addTo(mapInstance);
            L.marker([lat, lng]).addTo(mapInstance).bindPopup("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á").openPopup();
            const openBtn = document.getElementById('openInGMaps');
            if (openBtn) openBtn.href = link && link.startsWith('http') ? link : `https://www.google.com/maps/@${lat},${lng},17z`;
          } else {
            const mapDiv = document.getElementById('map');
            if (mapDiv) mapDiv.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 p-4 text-center">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</div>';
            const openBtn = document.getElementById('openInGMaps');
            if (openBtn) {
              if (link && link.startsWith('http')) openBtn.href = link;
              else { openBtn.classList.add('opacity-50'); openBtn.removeAttribute('href'); }
            }
          }
        }

        function closeMapModal() {
          const modal = document.getElementById('mapModal');
          modal.classList.add('hidden');
          if (mapInstance) {
            try { mapInstance.remove(); } catch(e) {}
            mapInstance = null;
          }
          const container = document.getElementById('mapContainer');
          if (container) container.innerHTML = '';
        }

        // escape helper for popup content
        function escapeHtml(unsafe) {
          if (!unsafe && unsafe !== 0) return '';
          return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
```