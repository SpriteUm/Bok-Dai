<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</title>
  <link href="{{ url_for('static', filename='dist/output.css') }}" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body class="font-kanit bg-custom-green-lightest min-h-screen font-kanit">
  <header class="bg-[#5C7F5C] shadow-xl">
    <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="text-xl font-bold text-white">
        {% if current_user.is_authenticated %}
          ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì {{ current_user.username }}
        {% else %}
          Bokdai
        {% endif %}
      </div>
      <div class="flex items-center gap-2">
        <a href="{{ url_for('index') }}" class="inline-block border bg-white px-4 py-1 mx-1 rounded-full text-sm font-medium">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        <a href="{{ url_for('report.report') }}" class="inline-block border bg-white px-4 py-1 mx-1 rounded-full text-sm font-medium">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</a>
        <a href="{{ url_for('auth.logout') }}" class="inline-block border bg-white px-4 py-1 mx-1 rounded-full text-sm font-medium">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>

        <a href="{{ url_for('indexuser.notifications') }}" class="relative inline-block ml-3">
          <button class="bg-white px-3 py-1 rounded-full text-sm">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
          {% if unread_notifications_count and unread_notifications_count > 0 %}
            <span class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">
              {{ unread_notifications_count }}
            </span>
          {% endif %}
        </a>
      </div>
    </nav>
  </header>

  <main class="container mx-auto p-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500 text-center">
        <p class="text-black text-sm">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>
        <p class="text-3xl font-bold mt-1 text-red-500">{{ total_issues or 0 }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-yellow-500 text-center">
        <p class="text-black text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
        <p class="text-3xl font-bold mt-1 text-yellow-500">{{ in_progress_issues or 0 }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500 text-center">
        <p class="text-black text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</p>
        <p class="text-3xl font-bold mt-1 text-green-500">{{ resolved_issues or 0 }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
      </div>
    </div>

    <hr class="border-custom-green-medium mb-8" />
    <h2 class="text-3xl font-bold mb-4 text-custom-green-dark">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>

    <div class="hidden md:flex justify-between items-center mb-3 p-4 bg-custom-green-dull-green rounded-t-lg text-sm font-medium">
      <div class="w-1/6">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
      <div class="w-2/6">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
      <div class="w-1/6 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
      <div class="w-1/6 text-center">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</div>
      <div class="w-1/6 text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
    </div>

    <div id="issue-list" class="space-y-2">
      {% if recent_issues %}
        {% for issue in recent_issues %}
          {# get latest history entry safely #}
          {% set latest = (issue.status_history | sort(attribute='timestamp', reverse=True) | first) if issue.status_history else None %}
          <div class="issue-card flex flex-col md:flex-row justify-between items-start md:items-center p-4 bg-white border rounded shadow-sm hover:shadow-md transition duration-150"
               data-issue-id="{{ issue.id }}">
            <div class="w-full md:w-1/6 mb-2 md:mb-0">
              <p class="text-sm font-medium">{{ issue.category or '-' }}</p>
              <p class="text-xs text-gray-500 mt-1">
                {% if issue.date_reported %}
                  {{ issue.date_reported }}
                {% elif issue.created_at %}
                  {% if issue.created_at is string %}{{ issue.created_at }}{% else %}{{ issue.created_at.strftime('%Y-%m-%d') }}{% endif %}
                {% else %}
                  -
                {% endif %}
              </p>
            </div>

            <div class="w-full md:w-2/6 mb-2 md:mb-0">
              <p class="text-sm text-gray-700 truncate">{{ issue.detail or '-' }}</p>
              <p class="text-xs text-gray-500 mt-1 truncate latest-notes">
                {% if latest and latest.notes %}‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {{ latest.notes[:100] }}{% if latest.notes|length > 100 %}...{% endif %}{% endif %}
              </p>
            </div>

            <div class="w-full md:w-1/6 flex flex-col items-center md:items-center mb-2 md:mb-0">
              <div class="status-badge">
                {% if issue.status == '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß' %}
                  <span class="inline-block bg-green-100 text-green-800 text-xs px-2.5 py-0.5 rounded-full">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</span>
                {% elif issue.status == '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' %}
                  <span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2.5 py-0.5 rounded-full">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                {% else %}
                  <span class="inline-block bg-red-100 text-red-800 text-xs px-2.5 py-0.5 rounded-full">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                {% endif %}
              </div>
              <div class="text-xs text-gray-400 mt-2">
                {% if issue.location_text %}{{ issue.location_text }}{% endif %}
              </div>
            </div>

            <div class="w-full md:w-1/6 text-center mb-2 md:mb-0">
              <p class="text-2xl">
                {% if issue.urgency in ['üî¥','red'] %}
                  üî¥
                {% elif issue.urgency in ['üü†','orange'] %}
                  üü†
                {% elif issue.urgency in ['üü¢','green'] %}
                  üü¢
                {% else %}
                  üü¢
                {% endif %}
              </p>
            </div>

            <div class="w-full md:w-1/6 flex items-center justify-end gap-3">
              <div class="latest-image-wrap">
                {% if latest and latest.response_image %}
                  <a href="{{ latest.response_image_url or url_for('static', filename='uploads/' ~ latest.response_image) }}" class="block" target="_blank" rel="noopener">
                    <img src="{{ latest.response_image_url or url_for('static', filename='uploads/' ~ latest.response_image) }}" alt="‡∏£‡∏π‡∏õ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö"
                         class="latest-thumb w-16 h-12 object-cover rounded border">
                  </a>
                {% else %}
                  <div class="latest-thumb-placeholder w-16 h-12 bg-gray-100 rounded border flex items-center justify-center text-xs text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>
                {% endif %}
              </div>

              <a href="{{ url_for('indexuser.view_issue', issue_id=issue.id) }}" class="inline-block px-4 py-2 bg-[#5C7F5C] text-white rounded-md text-sm hover:bg-[#4a684a] transition">
                ‡∏î‡∏π
              </a>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="p-6 bg-white rounded text-center text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      {% endif %}
    </div>

    {% if pagination %}
      <div class="mt-6 flex justify-center items-center gap-2">
        {% if pagination.has_prev %}
          <a href="{{ url_for('indexuser.indexuser', page=pagination.prev_num) }}" class="px-3 py-1 bg-white border rounded-md hover:bg-gray-100">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
        {% endif %}
        {% for p in pagination.iter_pages(left_edge=1,right_edge=1,left_current=2,right_current=2) %}
          {% if p %}
            {% if p == pagination.page %}
              <strong class="px-3 py-1 bg-[#5C7F5C] text-white rounded-md">{{ p }}</strong>
            {% else %}
              <a href="{{ url_for('indexuser.indexuser', page=p) }}" class="px-3 py-1 bg-white border rounded-md hover:bg-gray-100">{{ p }}</a>
            {% endif %}
          {% else %}
            <span class="px-3 py-1">...</span>
          {% endif %}
        {% endfor %}
        {% if pagination.has_next %}
          <a href="{{ url_for('indexuser.indexuser', page=pagination.next_num) }}" class="px-3 py-1 bg-white border rounded-md hover:bg-gray-100">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>
        {% endif %}
      </div>
    {% endif %}
  </main>

  <script>
    // Polling: ‡∏ó‡∏∏‡∏Å 8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ï‡∏£‡∏ß‡∏à issue ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á latest history (status, notes, response_image_url)
    // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ endpoint server: /indexuser/issue/<id>/latest.json  (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢‡πÑ‡∏ß‡πâ)
    (function () {
      const POLL_INTERVAL = 8000;
      const issueCards = document.querySelectorAll('.issue-card');
      if (!issueCards || issueCards.length === 0) return;

      async function fetchLatestForIssue(issueId) {
        try {
          const res = await fetch(`/indexuser/issue/${issueId}/latest.json`, { credentials: 'same-origin' });
          if (!res.ok) return null;
          return await res.json();
        } catch (e) {
          console.error('fetchLatestForIssue error', e);
          return null;
        }
      }

      async function updateCard(card) {
        const issueId = card.getAttribute('data-issue-id');
        if (!issueId) return;
        const data = await fetchLatestForIssue(issueId);
        if (!data) return;

        // Update status badge
        const badge = card.querySelector('.status-badge');
        if (badge && data.status) {
          let html = '';
          if (data.status === '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß') {
            html = '<span class="inline-block bg-green-100 text-green-800 text-xs px-2.5 py-0.5 rounded-full">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</span>';
          } else if (data.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
            html = '<span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2.5 py-0.5 rounded-full">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
          } else {
            html = '<span class="inline-block bg-red-100 text-red-800 text-xs px-2.5 py-0.5 rounded-full">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
          }
          badge.innerHTML = html;
        }

        // Update notes preview
        const notesEl = card.querySelector('.latest-notes');
        if (notesEl) {
          const notes = data.latest_history && data.latest_history.notes ? data.latest_history.notes : '';
          notesEl.textContent = notes ? `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${notes.length > 100 ? notes.slice(0,100) + '...' : notes}` : '';
        }

        // Update thumbnail
        const imgWrap = card.querySelector('.latest-image-wrap');
        if (imgWrap) {
          const lh = data.latest_history;
          if (lh && lh.response_image_url) {
            const url = lh.response_image_url + '?v=' + (lh.timestamp ? Date.parse(lh.timestamp) : Date.now());
            imgWrap.innerHTML = `<a href="${url}" class="block" target="_blank" rel="noopener">
              <img src="${url}" alt="‡∏£‡∏π‡∏õ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö" class="latest-thumb w-16 h-12 object-cover rounded border" />
              </a>`;
          } else {
            imgWrap.innerHTML = '<div class="latest-thumb-placeholder w-16 h-12 bg-gray-100 rounded border flex items-center justify-center text-xs text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>';
          }
        }
      }

      // initial run
      issueCards.forEach(card => updateCard(card));

      // periodic polling
      setInterval(() => {
        issueCards.forEach(card => updateCard(card));
      }, POLL_INTERVAL);
    })();
  </script>
</body>
</html>
